1) Setup a firewall, ufw is the package comming with ubuntu: 
ufw app list
Available applications:
    OpenSSH
ufw allow OpenSSH
ufw enable
ufw status
2) sudo apt update
3) Edit: 
    nano /etc/environment
    adding this line: 
    export GNUTLS_CPUID_OVERRIDE=0X1
4) sudo apt update
5) disable the firewall: sudo ufw allow 8000

6) gunicorn configuration:
    a) test: gunicorn --bind 0.0.0.0:8000 nas_manager.wsgi
        optional: gunicorn --bind 0.0.0.0:8000 nas_manager.wsgi:application

    b) sudo nano /etc/systemd/system/gunicorn.socket
        [Unit]
        Description=test NAS app

        [Socket]
        ListenStream=/run/gunicorn.sock

        [Install]
        WantedBy=sockets.target
    c) sudo nano /etc/systemd/system/gunicorn-nas.service
        [Unit]
        Description=gunicorn daemon, or instance to serve the Django NAS project
        Requires=gunicorn.socket
        After=network.target

        [Service]
        User=jesus
        Group=www-data
        UMask=007
        WorkingDirectory=/home/jesus/django/NAS/nas_manager/

        Environment="PATH=/home/jesus/django/.venv/bin/:$PATH"
        Environment=PYTHONPATH=/home/jesus/django/
        Environment=DJANGO_SETTINGS_MODULE=nas_manager.settings

        ExecStart=/home/jesus/django/.venv/bin/gunicorn \
                --access-logfile - \
                --workers 3 \  
                --bind unix:/run/gunicorn.sock nas_manager.wsgi:application

        # Standard output and error handling
        StandardOutput=journal
        StandardError=journal
        Restart=always
        
        [Install]
        WantedBy=multi-user.target

    d) Start our socket: sudo systemctl start gunicorn.socket
    e) enable the socket: sudo systemctl enable gunicorn.socket
    f) check: file /run/gunicorn.sock
        we should see: /run/gunicorn.sock: socket
    g) check status of systemctl: sudo sytemctl status gunicorn-nas.service
    h) enable but not activated, to activate: curl --unix-socket /run/gunicorn.sock localhost

20) Config Nginx server
    a) sudo nano /etc/nginx/sites-available/nas_manager
    server {
        listen 80;
        server_name jgpro-server.org raspberrypi-jesus 172.31.126.24 10.253.10.1;

        location = /favicon.ico { access_log off; log_not_found off; }
        location /static/ {
            alias /home/jesus/django/NAS/staticfiles/;
        }
    
        location / {
            include proxy_params;
            proxy_pass http://unix:/run/gunicorn.sock;
        }
    }
    b) Create symbolic link to enable the new config: 
    sudo ln -s /etc/nginx/sites-available/nas_config /etc/nginx/sites-enabled
    # optional: sudo ln -s /etc/nginx/sites-available/nas_config /etc/nginx/sites-enabled/
    c) test syntaxis: sudo nginx -t
    d) restart the nginx server: sudo systemctl restart nginx

21) enable firewall for port 8000: sudo ufw delete allow 8000

-------------------------------------------------------------------------------
How to proceed:
1) Start the services
# Enable and start the Gunicorn socket service (this handles starting gunicorn-nas.service on demand)
sudo systemctl enable gunicorn.socket
sudo systemctl start gunicorn.socket

# Enable and restart Nginx to load the new config
sudo ln -s /etc/nginx/sites-available/nas_manager /etc/nginx/sites-enabled/
sudo nginx -t # Check syntax
sudo systemctl restart nginx

2) Verify Status and Check logs:
# Verify the socket is active (it should be)
sudo systemctl status gunicorn.socket

# Check the Gunicorn service status (it should be running after the first web request)
sudo systemctl status gunicorn-nas.service

# Check Nginx service status
sudo systemctl status nginx

# Check Gunicorn logs for any errors (press 'q' to exit)
sudo journalctl -u gunicorn-nas.service -r -n 50

3) Test access:
curl htttp://127.0.0.1
