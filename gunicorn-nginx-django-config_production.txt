1) Setup a firewall, ufw is the package comming with ubuntu: 
ufw app list
Available applications:
    OpenSSH
ufw allow OpenSSH
ufw enable
ufw status
2) sudo apt update
3) Edit: 
    nano /etc/environment
    adding this line: 
    export GNUTLS_CPUID_OVERRIDE=0X1
4) sudo apt update
5) disable the firewall: sudo ufw allow 8000

6) gunicorn configuration:
    a) test: gunicorn --bind 0.0.0.0:8000 nas_manager.wsgi
        optional: gunicorn --bind 0.0.0.0:8000 nas_manager.wsgi:application

    b) sudo nano /etc/systemd/system/gunicorn.socket
        [Unit]
        Description=test NAS app

        [Socket]
        ListenStream=/run/gunicorn.sock

        [Install]
        WantedBy=sockets.target
    c) sudo nano /etc/systemd/system/gunicorn-nas.service
        [Unit]
        Description=gunicorn daemon, or instance to serve the Django NAS project
        Requires=gunicorn.socket
        After=network.target

        [Service]
        User=jesus
        Group=www-data
        UMask=007
        WorkingDirectory=/home/jesus/django/NAS/nas_manager/

        Environment="PATH=/home/jesus/django/.venv/bin/:$PATH"
        Environment=PYTHONPATH=/home/jesus/django/
        Environment=DJANGO_SETTINGS_MODULE=nas_manager.settings

        ExecStart=/home/jesus/django/.venv/bin/gunicorn \
                --access-logfile - \
                --workers 3 \  
                --bind unix:/run/gunicorn.sock nas_manager.wsgi:application

        # Standard output and error handling
        StandardOutput=journal
        StandardError=journal
        Restart=always
        
        [Install]
        WantedBy=multi-user.target

    d) Start our socket: sudo systemctl start gunicorn.socket
    e) enable the socket: sudo systemctl enable gunicorn.socket
    f) check: file /run/gunicorn.sock
        we should see: /run/gunicorn.sock: socket
    g) check status of systemctl: sudo sytemctl status gunicorn-nas.service
    h) enable but not activated, to activate: curl --unix-socket /run/gunicorn.sock localhost

20) Config Nginx server
    a) sudo nano /etc/nginx/sites-available/nas_manager
    server {
        listen 8080;
        server_name xxxxx.com xxxxxx  xxxxxxxxx;

        location = /favicon.ico { access_log off; log_not_found off; }
        location /static/ {
            alias /home/jesus/django/NAS/staticfiles/;
        }
    
        location / {
            include proxy_params;
            proxy_pass http://unix:/run/gunicorn.sock;
        }
    }
    b) Create symbolic link to enable the new config: 
    sudo ln -s /etc/nginx/sites-available/nas_config /etc/nginx/sites-enabled
    # optional: sudo ln -s /etc/nginx/sites-available/nas_config /etc/nginx/sites-enabled/
    c) test syntaxis: sudo nginx -t
    d) restart the nginx server: sudo systemctl restart nginx

21) enable firewall for port 8000: sudo ufw delete allow 8000

--------------------------------------------------------------------------
1) Configure the cloudflared tunnel
sudo nano /etc/cloudflared/config.yml

tunnel: <YOUR-TUNNEL-UUID>
credentials-file: /etc/cloudflared/<YOUR-TUNNEL-UUID>.json

ingress:
  # This is the rule that points the traffic to your Nginx server listening on 8080
  - hostname: jgpro-server.org 
    service: http://localhost:8080 # Points to the new internal Nginx port

  # Fallback rule
  - service: http_status:404

2) Update services
# Restart Nginx to load the new internal port 8080 listener
sudo nginx -t
sudo systemctl restart nginx

# Restart the cloudflared service to load the new ingress rules
sudo systemctl restart cloudflared
